<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具二：資料抽取</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* 頁面特定樣式覆寫 */
        body.tool-page-body {
            display: block;
            padding: 20px;
        }
        body.tool-page-body .container {
            max-width: none;
            width: auto;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
            text-align: left;
        }
    </style>
</head>
<body class="tool-page-body">
    <a href="data_processing_landing.html" class="btn-back">← 返回工具箱</a>

    <div class="tool-section">
        <h2>工具二：關鍵字篩選與資料抽取</h2>

        <div class="container">
            <div class="file-container">
                <div class="drop-zone" id="dropZoneFilter">
                    <p>將單一或多個 Excel 檔案拖曳至此</p>
                    <p class="file-list-display" id="filterFilesName"></p>
                    <input type="file" id="fileInputFilter" multiple style="display: none;">
                </div>
                <div class="sheet-list" id="sheetListFilter" style="display:none;"></div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-controls">
                <input type="text" id="keywordInput" placeholder="輸入關鍵字 (例如: 油)">
                <select id="headerSelectFilter"></select>
                <button id="filterButton" class="btn btn-primary" disabled>開始篩選與匯出</button>
            </div>
        </div>

        <div class="results">
            <p id="filterStatus"></p>
        </div>
    </div>

    <!-- 引入共用模組 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        // 主程式邏輯
        (function() {
            const dropZoneFilter = document.getElementById('dropZoneFilter');
            const fileInputFilter = document.getElementById('fileInputFilter');
            const filterFilesName = document.getElementById('filterFilesName');
            const sheetListFilter = document.getElementById('sheetListFilter');
            const keywordInput = document.getElementById('keywordInput');
            const headerSelectFilter = document.getElementById('headerSelectFilter');
            const filterButton = document.getElementById('filterButton');

            let allUploadedDataForFilter = [];
            let workbooksFilter = [];

            // 設置拖放區域（使用共用函數）
            setupDropZone(dropZoneFilter, fileInputFilter, handleFilterFiles);

            // 處理文件上傳
            async function handleFilterFiles(files) {
                filterFilesName.textContent = Array.from(files).map(f => f.name).join(', ');
                document.getElementById('filterStatus').textContent = `正在讀取 ${files.length} 個檔案...`;

                try {
                    // 使用共用函數讀取 Excel
                    workbooksFilter = await readExcelFiles(files);
                    displaySheetListForFilter();
                } catch(error) {
                    showErrorMessage(`讀取檔案失敗: ${error.message}`, 'filterStatus');
                }
            }

            // 顯示工作表列表
            function displaySheetListForFilter() {
                sheetListFilter.innerHTML = '';
                sheetListFilter.style.display = 'block';

                workbooksFilter.forEach(wbObj => {
                    const header = document.createElement('h4');
                    header.textContent = wbObj.name;
                    sheetListFilter.appendChild(header);

                    wbObj.workbook.SheetNames.forEach((sheetName, index) => {
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = sheetName;
                        checkbox.checked = (index === 0);
                        checkbox.dataset.filename = wbObj.name;
                        checkbox.onchange = updateDataForFilter;
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(` ${sheetName}`));
                        sheetListFilter.appendChild(label);
                    });
                });

                updateDataForFilter();
            }

            // 更新合併資料
            function updateDataForFilter() {
                let combinedData = [];
                const checkedBoxes = sheetListFilter.querySelectorAll('input:checked');

                checkedBoxes.forEach(cb => {
                    const fileName = cb.dataset.filename;
                    const sheetName = cb.value;
                    const wbObj = workbooksFilter.find(w => w.name === fileName);
                    if(wbObj) {
                        const worksheet = wbObj.workbook.Sheets[sheetName];
                        // 使用共用函數讀取工作表資料
                        combinedData = combinedData.concat(readSheetData(worksheet));
                    }
                });

                allUploadedDataForFilter = combinedData;

                if (allUploadedDataForFilter.length > 0) {
                    const headers = Object.keys(allUploadedDataForFilter[0]);
                    headerSelectFilter.innerHTML = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                    filterButton.disabled = false;
                    document.getElementById('filterStatus').textContent =
                        `資料淨化完成！共讀取 ${allUploadedDataForFilter.length} 筆有效資料，請輸入關鍵字篩選。`;
                } else {
                    filterButton.disabled = true;
                    document.getElementById('filterStatus').textContent = '請至少選擇一個包含資料的工作表。';
                }
            }

            // 篩選並匯出
            filterButton.addEventListener('click', async () => {
                const keyword = keywordInput.value.trim().toLowerCase();
                const selectedHeader = headerSelectFilter.value;

                // 驗證輸入
                if (!keyword) {
                    showErrorMessage('錯誤：請輸入要篩選的關鍵字。', 'filterStatus');
                    return;
                }
                if (!selectedHeader) {
                    showErrorMessage('錯誤：請選擇要篩選的標題欄位。', 'filterStatus');
                    return;
                }

                // 開始處理（使用共用進度函數）
                updateProgress(0, allUploadedDataForFilter.length, '正在篩選資料', 'filterStatus');
                await sleep(0);

                const filteredData = [];
                const remainingData = [];

                // 篩選資料
                for (let i = 0; i < allUploadedDataForFilter.length; i++) {
                    const row = allUploadedDataForFilter[i];
                    const cellValue = row[selectedHeader];

                    if (cellValue && String(cellValue).toLowerCase().includes(keyword)) {
                        filteredData.push(row);
                    } else {
                        remainingData.push(row);
                    }

                    // 每 100 筆更新一次進度
                    if (i % 100 === 0 || i === allUploadedDataForFilter.length - 1) {
                        updateProgress(i + 1, allUploadedDataForFilter.length, '篩選中', 'filterStatus');
                        await sleep(0);
                    }
                }

                // 產生檔案
                updateProgress(allUploadedDataForFilter.length, allUploadedDataForFilter.length,
                    '正在產生 Excel 檔案', 'filterStatus');
                await sleep(100);

                // 使用共用函數匯出
                if (filteredData.length > 0) {
                    exportToExcel(filteredData, 'filtered_data.xlsx', 'Filtered Data');
                }

                if (remainingData.length > 0) {
                    exportToExcel(remainingData, 'remaining_data.xlsx', 'Remaining Data');
                }

                // 顯示完成訊息（使用共用函數）
                showCompleteMessage(
                    '篩選完成！',
                    `符合條件的資料共 ${filteredData.length} 筆，已匯出為 filtered_data.xlsx。<br>剩餘的資料共 ${remainingData.length} 筆，已匯出為 remaining_data.xlsx。`,
                    'filterStatus'
                );
            });
        })();
    </script>
</body>
</html>
