<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工具三：資料欄位取代</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        /* 頁面特定樣式覆寫 */
        body.tool-page-body {
            display: block;
            padding: 20px;
        }
        body.tool-page-body .container {
            max-width: none;
            width: auto;
            padding: 0;
            box-shadow: none;
            background-color: transparent;
            text-align: left;
        }
        body.tool-page-body input[type="text"],
        body.tool-page-body select {
            width: auto;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #fff;
        }
        body.tool-page-body input[type="checkbox"] {
            width: auto;
        }

        /* 工具三特定樣式 */
        .replace-pair { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .replace-pair input { flex-grow: 1; }
        .remove-pair-btn { background-color: #ff4d4d; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        #addPairBtn { background-color: #007BFF; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .direct-replace-option { text-align: left; margin-bottom: 15px; padding-left: 10px;}
        .direct-replace-option label { cursor: pointer; }
        .config-section { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; }
    </style>
</head>
<body class="tool-page-body">
    <a href="data_processing_landing.html" class="btn-back">← 返回工具箱</a>
    <div class="tool-section">
        <h2>工具三：資料欄位取代</h2>
        <div class="container">
            <div class="file-container">
                <div class="drop-zone" id="dropZoneReplacer"><p>將一個或多個 Excel 檔案拖曳至此</p><p class="file-list-display" id="replacerFilesName"></p><input type="file" id="fileInputReplacer" multiple style="display: none;"></div>
            </div>
        </div>
        <div class="controls" id="replacerControls" style="display: none;">
            <div class="config-section">
                <span>選擇要取代內容的欄位:</span>
                <select id="headerSelectReplacer"></select>
            </div>
            <div class="direct-replace-option">
                <label><input type="checkbox" id="directReplaceCheckbox"> 不須尋找，直接取代整欄內容</label>
            </div>
            <h4>設定取代規則</h4>
            <div id="replacePairsContainer"></div>
            <button id="addPairBtn">新增一組取代規則</button>
            <hr style="margin: 20px 0;">
            <button id="replaceButton" class="btn btn-primary">開始取代並匯出</button>
        </div>
        <div class="results"><p id="replacerStatus"></p></div>
    </div>

    <!-- 引入共用模組 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        // 主程式邏輯
        (function() {
            const dropZone = document.getElementById('dropZoneReplacer');
            const fileInput = document.getElementById('fileInputReplacer');
            const filesNameDisplay = document.getElementById('replacerFilesName');
            const controls = document.getElementById('replacerControls');
            const headerSelect = document.getElementById('headerSelectReplacer');
            const pairsContainer = document.getElementById('replacePairsContainer');
            const addPairBtn = document.getElementById('addPairBtn');
            const replaceButton = document.getElementById('replaceButton');
            const statusDisplay = document.getElementById('replacerStatus');
            const directReplaceCheckbox = document.getElementById('directReplaceCheckbox');

            let allData = [];

            // 設置拖放區域（使用共用函數）
            setupDropZone(dropZone, fileInput, handleFiles);

            // 處理文件上傳
            async function handleFiles(files) {
                filesNameDisplay.textContent = Array.from(files).map(f => f.name).join(', ');
                statusDisplay.textContent = `正在讀取 ${files.length} 個檔案...`;

                try {
                    // 使用共用函數讀取 Excel
                    const workbooks = await readExcelFiles(files);
                    allData = [];

                    workbooks.forEach(wbObj => {
                        wbObj.workbook.SheetNames.forEach(sheetName => {
                            const ws = wbObj.workbook.Sheets[sheetName];
                            // 使用共用函數讀取工作表資料
                            allData = allData.concat(readSheetData(ws));
                        });
                    });

                    if (allData.length > 0) {
                        const headers = Object.keys(allData[0]);
                        headerSelect.innerHTML = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                        controls.style.display = 'block';
                        statusDisplay.textContent = `讀取完成！共 ${allData.length} 筆資料。請設定取代規則。`;
                        pairsContainer.innerHTML = '';
                        directReplaceCheckbox.checked = false;
                        addReplacePair();
                        directReplaceCheckbox.dispatchEvent(new Event('change'));
                    } else {
                        statusDisplay.textContent = '讀取的檔案中沒有找到有效資料。';
                        controls.style.display = 'none';
                    }
                } catch (error) {
                    showErrorMessage(`讀取檔案失敗: ${error.message}`, 'replacerStatus');
                }
            }

            function addReplacePair() {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'replace-pair';
                pairDiv.innerHTML = `
                    <input type="text" class="find-input" placeholder="尋找這個值...">
                    <span>取代為</span>
                    <input type="text" class="replace-input" placeholder="這個新值...">
                    <button class="remove-pair-btn">移除</button>
                `;
                pairsContainer.appendChild(pairDiv);
                
                pairDiv.querySelector('.remove-pair-btn').addEventListener('click', () => {
                    if (directReplaceCheckbox.checked && pairsContainer.children.length === 1) {
                        statusDisplay.textContent = '在「直接取代」模式下，至少需要保留一組規則。';
                        return;
                    }
                    pairDiv.remove();
                });

                const findInput = pairDiv.querySelector('.find-input');
                if (directReplaceCheckbox.checked) {
                    findInput.disabled = true;
                    findInput.placeholder = '已勾選「直接取代」，此欄位無效';
                    findInput.value = '';
                }
                return pairDiv;
            }
            
            addPairBtn.addEventListener('click', () => {
                if (directReplaceCheckbox.checked) {
                    statusDisplay.textContent = '在「直接取代」模式下，只能有一組取代規則。';
                    return;
                }
                addReplacePair();
            });

            directReplaceCheckbox.addEventListener('change', () => {
                const findInputs = document.querySelectorAll('#replacePairsContainer .find-input');
                const addPairButton = document.getElementById('addPairBtn');
                
                if (directReplaceCheckbox.checked) {
                    findInputs.forEach(input => {
                        input.value = '';
                        input.disabled = true;
                        input.placeholder = '已勾選「直接取代」，此欄位無效';
                    });
                    while (pairsContainer.children.length > 1) {
                        pairsContainer.lastChild.remove();
                    }
                    addPairButton.style.display = 'none';
                } else {
                    findInputs.forEach(input => {
                        input.disabled = false;
                        input.placeholder = '尋找這個值...';
                    });
                    addPairButton.style.display = 'inline-block';
                }
                statusDisplay.textContent = '';
            });

            // 取代功能（使用共用函數）
            replaceButton.addEventListener('click', async () => {
                const targetHeader = headerSelect.value;
                if (!targetHeader) {
                    showErrorMessage('錯誤：請選擇一個要處理的欄位。', 'replacerStatus');
                    return;
                }

                // 開始處理（使用共用進度函數）
                updateProgress(0, allData.length, '正在準備處理', 'replacerStatus');
                await sleep(0);
                
                let replacementsCount = 0;
                let finalProcessedData = [];

                if (directReplaceCheckbox.checked) {
                    const replaceInput = document.querySelector('.replace-pair .replace-input');
                    if (!replaceInput || (replaceInput.value.trim() === '' && replaceInput.value !== '')) {
                        showErrorMessage('錯誤：請為「直接取代」模式輸入要覆蓋的值。', 'replacerStatus');
                        return;
                    }
                    const replaceValue = replaceInput.value;

                    for (let i = 0; i < allData.length; i++) {
                        const row = allData[i];
                        const newRow = { ...row };
                        
                        if (String(newRow[targetHeader]) !== String(replaceValue)) {
                            newRow[targetHeader] = replaceValue;
                            replacementsCount++;
                        }
                        finalProcessedData.push(newRow);

                        // 每 100 筆更新一次進度
                        if (i % 100 === 0 || i === allData.length - 1) {
                            updateProgress(i + 1, allData.length, '直接取代中', 'replacerStatus');
                            await sleep(0);
                        }
                    }

                } else {
                    const pairs = Array.from(document.querySelectorAll('.replace-pair')).map(pairDiv => ({
                        find: pairDiv.querySelector('.find-input').value,
                        replace: pairDiv.querySelector('.replace-input').value
                    })).filter(p => p.find.trim() !== '');

                    if (pairs.length === 0) {
                        showErrorMessage('錯誤：在非「直接取代」模式下，請至少設定一組有效的尋找-取代規則。', 'replacerStatus');
                        return;
                    }

                    for (let i = 0; i < allData.length; i++) {
                        const row = allData[i];
                        const newRow = { ...row };
                        let cellValue = newRow[targetHeader];

                        if (cellValue !== null && cellValue !== undefined) {
                            let originalValue = String(cellValue);
                            let finalValue = originalValue;

                            for (const pair of pairs) {
                                const findRegex = new RegExp(pair.find.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g');
                                if (finalValue.match(findRegex)) {
                                   finalValue = finalValue.replace(findRegex, pair.replace);
                                }
                            }
                            
                            if (originalValue !== finalValue) {
                                newRow[targetHeader] = finalValue;
                                replacementsCount++;
                            }
                        }
                        finalProcessedData.push(newRow);

                        // 每 100 筆更新一次進度
                        if (i % 100 === 0 || i === allData.length - 1) {
                            updateProgress(i + 1, allData.length, '尋找並取代中', 'replacerStatus');
                            await sleep(0);
                        }
                    }
                }

                // 產生檔案（使用共用函數）
                updateProgress(allData.length, allData.length, '正在產生 Excel 檔案', 'replacerStatus');
                await sleep(100);

                exportToExcel(finalProcessedData, 'replaced_data.xlsx', 'Replaced Data');

                // 顯示完成訊息（使用共用函數）
                showCompleteMessage(
                    '處理完成！',
                    `共取代了 ${replacementsCount} 個儲存格的內容。<br>已匯出為 replaced_data.xlsx。`,
                    'replacerStatus'
                );
            });
        })();
    </script>
</body>
</html>